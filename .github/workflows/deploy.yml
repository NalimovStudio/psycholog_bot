name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Poetry
        run: |
          pip install poetry

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Create test .env file
        run: |
          cat > .env << 'EOF'
          # Test Environment Configuration
          DB_DRIVER=${{ secrets.DB_DRIVER }}
          DB_SYSTEM=${{ secrets.DB_SYSTEM }}
          DB_HOST=localhost
          DB_PORT=5432
          DB_NAME=test_db
          DB_USER=test_user
          DB_PASSWORD=test_password
          DB_PATH=
          
          REDIS_HOST=localhost
          REDIS_PORT=6379
          REDIS_USERNAME=test
          REDIS_PASSWORD=test
          REDIS_DATABASE=1
          
          TELEGRAM_TOKEN=test_token
          ASSISTANT_API_KEY=test_key
          
          ENVIRONMENT=test
          LOG_LEVEL=DEBUG
          EOF

      - name: Install dependencies with Poetry
        run: |
          poetry install --no-interaction --no-ansi

      - name: Run unit tests with Poetry
        run: |
          poetry run pytest tests/ -v --tb=short



  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          ssh-known-hosts: ${{ secrets.SSH_HOST_FINGERPRINT }}

      - name: Check SSH key
        run: |
          # Проверяем содержимое ключа
          echo "=== Key content ==="
          echo "${{ secrets.SSH_PRIVATE_KEY }}"
          
          # Сохраняем и проверяем
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/debug_key
          chmod 600 ~/.ssh/debug_key
          
          echo "=== Key info ==="
          ssh-keygen -l -f ~/.ssh/debug_key || echo "Invalid key format"

      - name: Setup SSH keys
        run: |
          # Создаем директорию .ssh
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Сохраняем приватный ключ
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Добавляем хост в known_hosts
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

          # Проверяем ключ
          ssh-keygen -l -f ~/.ssh/id_ed25519

      - name: Copy files to server
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='__pycache__' \
            --exclude='.pytest_cache' \
            --exclude='.env' \
            --exclude='.venv' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:~/app/TraumaBot

      - name: Create production .env file on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ~/app/TraumaBot
            cat > .env << 'ENV_EOF'
            # Production Environment Configuration
            DB_DRIVER=${{ secrets.DB_DRIVER }}
            DB_SYSTEM=${{ secrets.DB_SYSTEM }}
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_NAME=${{ secrets.DB_NAME || 'psychoAI_db' }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_PATH=${{ secrets.DB_PATH }}
            
            REDIS_HOST=${{ secrets.REDIS_HOST }}
            REDIS_PORT=${{ secrets.REDIS_PORT }}
            REDIS_USERNAME=${{ secrets.REDIS_USERNAME }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            REDIS_DATABASE=${{ secrets.REDIS_DATABASE }}
            
            TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
            ASSISTANT_API_KEY=${{ secrets.ASSISTANT_API_KEY }}
            
            ENVIRONMENT=production
            LOG_LEVEL=INFO
            ENV_EOF
            
            chmod 600 .env
            echo "✓ Production .env file created successfully"
          EOF

      - name: Deploy with Docker Compose
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ~/app/TraumaBot
            docker-compose down
            docker-compose pull
            docker-compose build --no-cache
            docker-compose up -d
            
            sleep 15
            echo "=== Container status ==="
            docker-compose ps
            echo "=== Recent logs ==="
            docker-compose logs --tail=30
          EOF

      - name: Health check after deploy
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ~/app/TraumaBot
            echo "=== Running containers ==="
            docker-compose ps | grep -v "Exit"
            
            echo "=== Error check ==="
            docker-compose logs --tail=50 | grep -i "error\|exception\|fail" || echo "✓ No errors found"
            
            echo "=== PostgreSQL health check ==="
            docker-compose exec -T db pg_isready -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME || 'psychoAI_db' }} && echo "✓ PostgreSQL is healthy"
            
            echo "=== .env file check ==="
            if [ -f .env ]; then
              echo "✓ .env file exists"
              cat .env | sed 's/=.*/=***/' | head -10
            else
              echo "✗ .env file missing"
            fi
          EOF